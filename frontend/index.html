<!DOCTYPE html>
<html lang="th" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบสำรวจร่องรอยน้ำท่วม</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Athiti:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Marker Cluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

  <style>
    html,
    body {
      height: 100%;
    }

    body {
      box-sizing: border-box;
      font-family: 'Athiti', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 30%, #f1f5f9 70%, #e2e8f0 100%);
      color: #0f172a;
      position: relative;
      overflow-x: hidden;
    }

    /* ===== Ambient glow blobs ===== */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 560px;
      height: 560px;
      filter: blur(70px);
      opacity: .35;
      z-index: -1;
      pointer-events: none;
      border-radius: 999px;
      transform: translateZ(0);
      animation: floaty 10s ease-in-out infinite;
    }

    body::before {
      left: -160px;
      top: -200px;
      background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, .75), rgba(6, 182, 212, .35), transparent 70%);
    }

    body::after {
      right: -200px;
      bottom: -240px;
      background: radial-gradient(circle at 40% 40%, rgba(99, 102, 241, .65), rgba(96, 165, 250, .35), transparent 70%);
      animation-delay: -4s;
    }

    @keyframes floaty {

      0%,
      100% {
        transform: translateY(0) translateX(0) scale(1);
      }

      50% {
        transform: translateY(18px) translateX(12px) scale(1.04);
      }
    }

    /* ---- Glass / 3D Cards ---- */
    .card-3d {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid transparent;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)),
        linear-gradient(135deg, #60a5fa, #3b82f6, #06b6d4);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15), 0 0 60px rgba(96, 165, 250, 0.08);
      backdrop-filter: blur(20px);
      transition: all 0.4s ease;
    }

    .card-3d:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.25), 0 0 80px rgba(96, 165, 250, 0.15);
    }

    .map-container {
      background: linear-gradient(135deg, rgba(224, 242, 254, 0.8) 0%, rgba(241, 245, 249, 0.9) 100%);
      border: 2px solid rgba(59, 130, 246, 0.3);
      box-shadow: inset 0 2px 30px rgba(96, 165, 250, 0.15), 0 0 40px rgba(59, 130, 246, 0.1);
      backdrop-filter: blur(20px);
    }

    /* ---- Upload area ---- */
    .upload-area {
      border: 3px dashed rgba(96, 165, 250, 0.4);
      transition: all 0.4s ease;
      background: rgba(224, 242, 254, 0.3);
      backdrop-filter: blur(15px);
      box-shadow: inset 0 0 30px rgba(59, 130, 246, 0.08);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .upload-area::after {
      content: "";
      position: absolute;
      inset: -120px;
      background: radial-gradient(circle, rgba(255, 255, 255, .35) 0%, transparent 55%);
      transform: translateX(-40%);
      transition: transform .6s ease;
      pointer-events: none;
    }

    .upload-area:hover::after {
      transform: translateX(10%);
    }

    .upload-area:hover {
      border-color: rgba(59, 130, 246, 0.7);
      background: rgba(224, 242, 254, 0.5);
      transform: scale(1.02);
      box-shadow: 0 0 40px rgba(96, 165, 250, 0.25), inset 0 0 40px rgba(59, 130, 246, 0.12);
    }

    .upload-area.dragover {
      border-color: #3b82f6;
      background: rgba(224, 242, 254, 0.7);
      transform: scale(1.05);
      box-shadow: 0 0 60px rgba(59, 130, 246, 0.4);
    }

    /* ---- Buttons / Inputs ---- */
    .btn-3d {
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.35), 0 8px 20px rgba(96, 165, 250, 0.25);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: none;
    }

    .btn-3d::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-3d:hover::before {
      width: 320px;
      height: 320px;
    }

    .btn-3d:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 50px rgba(59, 130, 246, 0.55), 0 15px 40px rgba(96, 165, 250, 0.45);
    }

    .btn-3d:active {
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.45);
    }

    .input-3d {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(96, 165, 250, 0.3);
      color: #0f172a;
      box-shadow: inset 0 2px 8px rgba(59, 130, 246, 0.08);
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .input-3d:focus {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 0 30px rgba(96, 165, 250, 0.3), inset 0 2px 8px rgba(59, 130, 246, 0.08);
      outline: none;
    }

    /* ---- Header ---- */
    .header-gradient {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(224, 242, 254, 0.95) 50%, rgba(241, 245, 249, 0.98) 100%);
      box-shadow: 0 8px 40px rgba(59, 130, 246, 0.15), 0 0 60px rgba(96, 165, 250, 0.1);
      border-bottom: 2px solid rgba(96, 165, 250, 0.2);
      backdrop-filter: blur(20px);
    }

    /* ---- Stat cards ---- */
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid transparent;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)),
        linear-gradient(135deg, #60a5fa, #06b6d4);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.15), 0 8px 20px rgba(96, 165, 250, 0.1);
      backdrop-filter: blur(20px);
      transition: all 0.4s ease;
    }

    .stat-card:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 0 60px rgba(59, 130, 246, 0.3), 0 20px 50px rgba(96, 165, 250, 0.2);
    }

    /* ---- Neon border hover ---- */
    .neon-border {
      position: relative;
    }

    .neon-border::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, #6366f1, #818cf8, #a5b4fc, #818cf8, #6366f1);
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
      animation: neonRotate 3s linear infinite;
      background-size: 200% 200%;
    }

    .neon-border:hover::before {
      opacity: 0.7;
    }

    @keyframes neonRotate {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* ===== Section title with icon ===== */
    .section-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .section-icon {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(59, 130, 246, .16), rgba(6, 182, 212, .14));
      border: 1px solid rgba(59, 130, 246, .25);
      box-shadow: 0 0 30px rgba(59, 130, 246, .18);
      backdrop-filter: blur(18px);
      flex: 0 0 auto;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: .2px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 45%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      line-height: 1.2;
    }

    .section-sub {
      margin-top: 2px;
      font-size: .9rem;
      color: rgba(51, 65, 85, .85);
      font-weight: 600;
    }

    /* ===== Recent report item hover slide ===== */
    .report-item {
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
      position: relative;
      overflow: hidden;
    }

    .report-item::after {
      content: "";
      position: absolute;
      inset: -120px;
      background: radial-gradient(circle, rgba(255, 255, 255, .35) 0%, transparent 55%);
      transform: translateX(-55%);
      transition: transform .5s ease;
      pointer-events: none;
    }

    .report-item:hover {
      transform: translateX(10px);
      box-shadow: 0 14px 40px rgba(59, 130, 246, .18);
      background: rgba(255, 255, 255, .78);
    }

    .report-item:hover::after {
      transform: translateX(5%);
    }

    /* ---- Modals (compat with original JS) ---- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 39, 0.75);
      z-index: 2000;
      display: none;
      backdrop-filter: blur(12px);
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-box {
      position: relative;
      background: rgba(255, 255, 255, .95);
      border-radius: 1rem;
      width: 100%;
      max-width: 42rem;
      margin: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
      z-index: 2001;
      border: 1px solid rgba(59, 130, 246, .18);
      backdrop-filter: blur(20px);
    }

    body.modal-open {
      overflow: hidden;
    }

    /* Make export button pop */
    #exportBtn {
      background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 0 40px rgba(37, 99, 235, 0.35), 0 10px 24px rgba(6, 182, 212, 0.18);
    }

    #exportBtn:hover {
      filter: brightness(1.06);
      box-shadow: 0 0 60px rgba(37, 99, 235, 0.5), 0 16px 40px rgba(6, 182, 212, 0.28);
    }
  </style>

  <script>
    // Base path for API calls - set to /watermark for sub-path deployment
    const API_BASE = "/watermark";

    const SKIP_INFER = new URLSearchParams(location.search).get("debug") === "1" ? 1 : 0;
    const MAX_MB = 10;
    const ALLOWED_MIME = ["image/jpeg", "image/png", "image/webp"];
    const DEFAULT_BOUNDARY_URL = "./cm_boundary.geojson";
  </script>
</head>

<body class="h-full">
  <div class="h-full overflow-auto">
    <!-- Header -->
    <header class="header-gradient">
      <div class="container mx-auto px-4 py-6">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h1 class="text-3xl font-bold"
              style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #06b6d4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
              ระบบรวบรวมร่องรอยน้ำท่วม
            </h1>
            <p class="text-slate-700 mt-2 text-lg font-medium">
              รวบรวมข้อมูลจากภาพถ่ายภาคสนามเพื่อสร้างแผนที่ระดับน้ำท่วมย้อนหลัง
            </p>
          </div>

          <div class="text-right rounded-2xl p-5 backdrop-blur-sm border-2 border-blue-400/40"
            style="background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(224,242,254,.8)); box-shadow: 0 0 40px rgba(59,130,246,.25), inset 0 2px 20px rgba(96,165,250,.1);">
            <div class="text-sm font-semibold text-blue-700">ข้อมูลทั้งหมด</div>
            <div class="text-4xl font-bold" id="totalReports"
              style="background: linear-gradient(135deg, #3b82f6, #06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
              0
            </div>
            <div class="text-sm font-semibold text-blue-700">รายงาน</div>

            <button id="exportBtn"
              class="mt-4 w-full px-4 py-3 rounded-xl btn-3d font-semibold flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4" stroke-linecap="round"
                  stroke-linejoin="round" stroke-width="2" />
              </svg>
              ดาวน์โหลดข้อมูล
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <div class="container mx-auto px-4 py-8">
      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Upload -->
        <div class="rounded-xl p-6 card-3d">
          <div class="section-head">
            <div class="section-icon">
              <!-- upload icon -->
              <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 12v9m0-9l-3 3m3-3l3 3"
                  stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            <div>
              <h2 class="section-title">อัปโหลดภาพร่องรอยน้ำท่วม</h2>
              <div class="section-sub">เพิ่มข้อมูลภาคสนามเพื่อทำแผนที่น้ำท่วมย้อนหลัง</div>
            </div>
          </div>

          <div class="upload-area rounded-xl p-8 text-center mb-6 neon-border" id="uploadArea">
            <svg class="w-20 h-20 mx-auto mb-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" />
            </svg>
            <p class="text-lg text-blue-700 mb-2 font-medium">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
            <p class="text-sm text-slate-600 font-medium">รองรับไฟล์ JPG, PNG, WEBP (ขนาดไม่เกิน 10MB)</p>
            <input type="file" id="imageInput" accept="image/*" class="hidden" multiple>
            <div id="fileInfo" class="mt-3 text-sm text-slate-600 font-medium"></div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">ตำแหน่งที่พบ</label>
              <div class="flex gap-2 flex-wrap">
                <input id="locationInput" type="text" placeholder='เช่น "18.7883, 98.9853"'
                  class="flex-1 min-w-[220px] px-4 py-3 rounded-xl input-3d">
                <button id="getLocationBtn"
                  class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl btn-3d whitespace-nowrap font-medium">
                  ใช้ตำแหน่งปัจจุบัน
                </button>
                <button id="pickOnMapBtn"
                  class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl btn-3d whitespace-nowrap font-medium">
                  ปักหมุดบนแผนที่
                </button>
              </div>
              <div id="locationStatus" class="mt-2 text-sm hidden font-medium"></div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">ที่อยู่/จุดสังเกต (ถ้ามี)</label>
              <input id="addressInput" type="text" placeholder="เช่น หน้าร้าน..., ซอย..., ตรงข้าม..."
                class="w-full px-4 py-3 rounded-xl input-3d">
              <p class="text-xs text-slate-600 mt-1 font-medium">ถ้าเว้นว่าง ระบบจะใช้ค่าจากช่องพิกัด (lat, lng)
                ให้อัตโนมัติ</p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">วัตถุที่ถ่าย</label>
              <select id="objectTypeInput" class="w-full px-4 py-3 rounded-xl input-3d">
                <option value="">เลือกวัตถุที่ถ่าย</option>
                <option value="เสาไฟ">เสาไฟ</option>
                <option value="รั้วบ้าน">รั้วบ้าน</option>
                <option value="อื่นๆ">อื่นๆ (ระบุเอง)</option>
              </select>
            </div>

            <div id="customObjectDiv" class="hidden">
              <label class="block text-sm font-semibold text-slate-800 mb-2">ระบุวัตถุ</label>
              <input id="customObjectInput" type="text" placeholder="เช่น ป้ายจราจร, ต้นไม้, อาคาร"
                class="w-full px-4 py-3 rounded-xl input-3d">
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">รายละเอียดเพิ่มเติม</label>
              <textarea id="descriptionInput" rows="3" placeholder="อธิบายลักษณะรอยน้ำ สภาพแวดล้อม หรือข้อมูลเพิ่มเติม"
                class="w-full px-4 py-3 rounded-xl input-3d"></textarea>
            </div>

            <button id="submitBtn"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl btn-3d">
              บันทึกข้อมูล
            </button>
          </div>
        </div>

        <!-- Map + list -->
        <div class="space-y-6">
          <div class="rounded-xl p-6 card-3d">
            <div class="section-head">
              <div class="section-icon">
                <!-- map icon -->
                <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M9 20l-5 2V6l5-2 6 2 5-2v16l-5 2-6-2z" stroke-width="1.8" stroke-linejoin="round" />
                  <path d="M9 4v16M15 6v16" stroke-width="1.8" stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2 class="section-title">แผนที่ร่องรอยน้ำท่วม</h2>
                <div class="section-sub">ดูจุดสำรวจ + การประมาณค่าพื้นที่ (Interpolation)</div>
              </div>
            </div>

            <div id="floodMap" class="map-container rounded-xl h-[520px] overflow-hidden"></div>

            <div class="mt-4 flex items-center gap-2 flex-wrap">
              <button id="toggleIdw"
                class="px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl btn-3d font-medium">
                แสดง/ซ่อนแผนที่ Interpolation
              </button>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex flex-wrap gap-4 text-sm font-medium">
              <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 rounded-full mr-2" style="box-shadow: 0 0 10px #ef4444;"></div>
                <span class="text-slate-700">สูง (120+ ซม.)</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 bg-orange-500 rounded-full mr-2" style="box-shadow: 0 0 10px #f97316;"></div>
                <span class="text-slate-700">ปานกลาง (60–120 ซม.)</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2" style="box-shadow: 0 0 10px #eab308;"></div>
                <span class="text-slate-700">ต่ำ (0–60 ซม.)</span>
              </div>
            </div>
          </div>

          <div class="rounded-xl p-6 card-3d">
            <div class="section-head">
              <div class="section-icon">
                <!-- list icon -->
                <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M8 6h13M8 12h13M8 18h13" stroke-width="1.8" stroke-linecap="round" />
                  <path d="M3.5 6h.5M3.5 12h.5M3.5 18h.5" stroke-width="2.6" stroke-linecap="round" />
                </svg>
              </div>
              <div>
                <h2 class="section-title">รายงานล่าสุด</h2>
                <div class="section-sub">แสดง 5 รายการล่าสุด (Hover เพื่อดูฟีล)</div>
              </div>
            </div>

            <div id="recentReports" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="mt-8 grid md:grid-cols-4 gap-6">
        <div class="rounded-xl p-6 text-center stat-card neon-border">
          <div id="avgLevel" class="text-3xl font-bold text-blue-600">0</div>
          <div class="text-sm text-slate-700 mt-2 font-semibold">ความสูงรอยน้ำเฉลี่ย (ซม.)</div>
        </div>
        <div class="rounded-xl p-6 text-center stat-card neon-border">
          <div id="highRisk" class="text-3xl font-bold text-red-600">0</div>
          <div class="text-sm text-slate-700 mt-2 font-semibold">พื้นที่น้ำเคยท่วมสูง</div>
        </div>
        <div class="rounded-xl p-6 text-center stat-card neon-border">
          <div id="totalAreas" class="text-3xl font-bold text-green-600">0</div>
          <div class="text-sm text-slate-700 mt-2 font-semibold">จำนวนจุดสำรวจ</div>
        </div>
        <div class="rounded-xl p-6 text-center stat-card neon-border">
          <div id="lastUpdate" class="text-3xl font-bold text-purple-600">-</div>
          <div class="text-sm text-slate-700 mt-2 font-semibold">อัปเดตล่าสุด</div>
        </div>
      </div>
    </div>

    <!-- ===== Modal: Alert ===== -->
    <div id="alertModal" class="modal-backdrop items-center justify-center">
      <div class="modal-box w-full max-w-md mx-4">
        <div class="px-5 py-4 border-b border-blue-100">
          <h3 id="alertTitle" class="text-lg font-semibold text-slate-800">แจ้งเตือน</h3>
        </div>
        <div class="px-5 py-4">
          <p id="alertMessage" class="text-sm text-slate-700"></p>
        </div>
        <div class="px-5 py-4 border-t border-blue-100 flex justify-end gap-2">
          <button id="alertClose"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg btn-3d">ปิด</button>
        </div>
      </div>
    </div>

    <!-- ===== Modal: Export ===== -->
    <div id="exportModal" class="modal-backdrop items-center justify-center">
      <div class="modal-box w-full max-w-lg mx-4">
        <div class="px-5 py-4 border-b border-blue-100 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-slate-800">ดาวน์โหลดข้อมูล</h3>
            <p class="text-sm text-slate-600 mt-1">เลือกรูปแบบที่ต้องการดาวน์โหลด</p>
          </div>
          <button id="exportCloseX" class="text-2xl leading-none text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <div class="px-5 py-4 space-y-4">
          <div class="border border-blue-100 rounded-xl p-4 bg-white/70">
            <h4 class="font-semibold text-slate-800">ข้อมูลรายงาน (CSV)</h4>
            <div class="mt-3">
              <button id="exportCsvBtn"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg btn-3d">ดาวน์โหลด CSV</button>
            </div>
          </div>
          <div class="border border-blue-100 rounded-xl p-4 bg-white/70">
            <h4 class="font-semibold text-slate-800">ชั้นแผนที่ Interpolation</h4>
            <p class="text-sm text-slate-600 mt-1">ดาวน์โหลดเป็น GeoJSON</p>
            <div class="mt-3">
              <button id="exportIdwBtn"
                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg btn-3d">ดาวน์โหลด
                GeoJSON</button>
            </div>
          </div>
        </div>
        <div class="px-5 py-4 border-t border-blue-100 flex justify-end gap-2">
          <button id="exportClose"
            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-lg">ปิด</button>
        </div>
      </div>
    </div>

    <!-- ===== Modal: Pick-on-map ===== -->
    <div id="pickModal" class="modal-backdrop items-center justify-center">
      <div class="modal-box w-full max-w-3xl mx-4">
        <div class="px-5 py-4 border-b border-blue-100 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-slate-800">โปรดปักหมุดเพื่อระบุพิกัด</h3>
            <p class="text-sm text-slate-600 mt-1">คลิกบนแผนที่เพื่อเลือกจุด • สลับพื้นหลังได้</p>
          </div>
          <button id="pickCloseX" class="text-2xl leading-none text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <div class="px-5 pt-4 pb-2">
          <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
            <div class="space-x-2">
              <button id="pickBaseOsm" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg">แผนที่</button>
              <button id="pickBaseEsri" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg">ดาวเทียม</button>
            </div>
            <div class="text-sm text-slate-700 font-medium">
              พิกัดที่เลือก: <span id="pickedLatLng">-</span>
            </div>
          </div>
          <div id="pickMap" class="h-[420px] rounded-xl border border-blue-100 overflow-hidden"></div>
        </div>
        <div class="px-5 py-4 border-t border-blue-100 flex justify-end gap-2">
          <button id="pickCancel"
            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-lg">ยกเลิก</button>
          <button id="pickConfirm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg btn-3d"
            disabled>ยืนยันพิกัด</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts (logic เดิม / เพิ่ม class report-item ใน renderReports เท่านั้น) -->
  <script>
    let floodReports = [];
    let idwLayer = null;
    let lastIdwGeoJson = null;
    let boundaryLayer = null;
    let boundaryGeoJson = null;

    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    const totalReportsEl = document.getElementById('totalReports');
    const recentReportsEl = document.getElementById('recentReports');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const pickOnMapBtn = document.getElementById('pickOnMapBtn');
    const locationInput = document.getElementById('locationInput');
    const addressInput = document.getElementById('addressInput');
    const locationStatus = document.getElementById('locationStatus');
    const objectTypeInput = document.getElementById('objectTypeInput');
    const customObjectDiv = document.getElementById('customObjectDiv');
    const customObjectInput = document.getElementById('customObjectInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const exportBtn = document.getElementById('exportBtn');

    const alertModal = document.getElementById('alertModal');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertClose = document.getElementById('alertClose');

    const exportModal = document.getElementById('exportModal');
    const exportClose = document.getElementById('exportClose');
    const exportCloseX = document.getElementById('exportCloseX');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportIdwBtn = document.getElementById('exportIdwBtn');

    const pickModal = document.getElementById('pickModal');
    const pickCancel = document.getElementById('pickCancel');
    const pickConfirm = document.getElementById('pickConfirm');
    const pickedLatLngEl = document.getElementById('pickedLatLng');
    const pickBaseOsmBtn = document.getElementById('pickBaseOsm');
    const pickBaseEsriBtn = document.getElementById('pickBaseEsri');

    function openModal(el) { el.classList.add('show'); document.body.classList.add('modal-open'); }
    function closeModal(el) { el.classList.remove('show'); document.body.classList.remove('modal-open'); }

    function showAlert(title, message) {
      alertTitle.textContent = title || 'แจ้งเตือน';
      alertMessage.textContent = message || '';
      openModal(alertModal);
    }
    alertClose.addEventListener('click', () => closeModal(alertModal));
    alertModal.addEventListener('click', (e) => { if (e.target === alertModal) closeModal(alertModal); });

    function showExport() { openModal(exportModal); }
    function hideExport() { closeModal(exportModal); }
    exportBtn.addEventListener('click', showExport);
    exportClose?.addEventListener('click', hideExport);
    exportCloseX?.addEventListener('click', hideExport);
    exportModal.addEventListener('click', (e) => { if (e.target === exportModal) hideExport(); });

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' });
    const imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });

    if (window.__leaflet_map__) { window.__leaflet_map__.remove(); }
    const map = L.map('floodMap', { layers: [osm] }).setView([18.7883, 98.9853], 12);
    window.__leaflet_map__ = map;

    map.createPane('idwPane'); map.getPane('idwPane').style.zIndex = 350;
    map.createPane('boundaryPane'); map.getPane('boundaryPane').style.zIndex = 360;

    const baseLayers = { "แผนที่": osm, "ดาวเทียม": imagery };
    const overlays = {};
    L.control.layers(baseLayers, overlays, { position: 'topright', collapsed: false }).addTo(map);

    const markersCluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
    map.addLayer(markersCluster);

    function severityColorByCm(cm) { if (cm > 120) return '#ef4444'; if (cm > 60) return '#f97316'; return '#eab308'; }
    function colorByCm(cm) { if (cm > 120) return '#ef4444'; if (cm > 60) return '#f59e0b'; return '#84cc16'; }

    function thDateTime(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      if (isNaN(d)) return '-';
      return d.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', hour12: false });
    }

    function addReportToMap(report) {
      const val = (report.water_level_m ?? report.water_level_raw_m);
      const hasVal = (val != null && isFinite(val));
      const cm = hasVal ? Math.round(val * 100) : null;
      const color = hasVal ? severityColorByCm(cm) : '#6b7280';

      const marker = L.circleMarker([report.lat, report.lng], {
        radius: 8,
        color,
        fillColor: color,
        fillOpacity: 0.85
      })
        .bindPopup(`
          <div style="font-size:14px;">
            <div><b>พิกัด:</b> ${report.address || `${report.lat}, ${report.lng}`}</div>
            <div><b>ความสูงรอยน้ำ:</b> ${hasVal ? Number(val).toFixed(2) + ' m' : '—'}</div>
            <div><b>วัตถุที่ถ่าย:</b> ${report.object_type || '-'}</div>
            <div><b>รายละเอียดเพิ่มเติม:</b> ${report.description || '-'}</div>
            <div><b>วันที่เก็บข้อมูล:</b> ${thDateTime(report.date_iso)}</div>
            ${report.photo_url ? `<div style="margin-top:6px;"><a href="${API_BASE}${report.photo_url}" target="_blank" style="color:#2563eb;text-decoration:underline;">เปิดภาพ</a></div>` : ''}
          </div>`);
      markersCluster.addLayer(marker);
    }

    function fitMapToMarkers() {
      const count = markersCluster.getLayers().length;
      if (count > 0) map.fitBounds(markersCluster.getBounds(), { padding: [30, 30] });
    }

    function showLocationStatus(msg, type) {
      locationStatus.classList.remove('hidden');
      locationStatus.className = `mt-2 text-sm font-medium ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600'}`;
      locationStatus.textContent = msg;
      if (type === 'success' || type === 'error') setTimeout(() => locationStatus.classList.add('hidden'), 3000);
    }

    function timeAgo(date) {
      if (!(date instanceof Date) || isNaN(date)) return '-';
      const now = new Date();
      const diffMin = Math.floor((now - date) / 60000);
      if (diffMin < 1) return 'เมื่อครู่';
      if (diffMin < 60) return `${diffMin} นาทีที่แล้ว`;
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return `${diffHr} ชั่วโมงที่แล้ว`;
      return date.toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' });
    }

    function latestDateFromReports() {
      let maxT = -Infinity;
      for (const r of floodReports) {
        if (!r?.date_iso) continue;
        const t = new Date(r.date_iso).getTime();
        if (!isNaN(t) && t > maxT) maxT = t;
      }
      return maxT === -Infinity ? null : new Date(maxT);
    }

    function updateStats() {
      totalReportsEl.textContent = floodReports.length;
      const nums = floodReports
        .map(r => r.water_level_m ?? r.water_level_raw_m)
        .filter(v => v != null && isFinite(v));
      if (!nums.length) {
        document.getElementById('avgLevel').textContent = 0;
        document.getElementById('highRisk').textContent = 0;
        document.getElementById('totalAreas').textContent = floodReports.length;
        document.getElementById('lastUpdate').textContent = '-';
        return;
      }
      const avg_m = nums.reduce((s, v) => s + v, 0) / nums.length;
      const avg_cm = Math.round(avg_m * 100);
      document.getElementById('avgLevel').textContent = avg_cm;

      const highRisk = nums.filter(v => v * 100 > 120).length;
      document.getElementById('highRisk').textContent = highRisk;
      document.getElementById('totalAreas').textContent = floodReports.length;

      const lastD = latestDateFromReports();
      document.getElementById('lastUpdate').textContent = lastD ? timeAgo(lastD) : '-';
    }

    // ✅ เพิ่ม class "report-item" เพื่อให้ hover slide + glow ทำงาน (ไม่เปลี่ยน logic)
    function renderReports() {
      const badge = (cm, hasVal) => {
        if (!hasVal) return { text: 'ไม่มีค่า', bg: '#e5e7eb', fg: '#374151', border: '#9ca3af' };
        if (cm > 120) return { text: 'สูง', bg: '#fee2e2', fg: '#991b1b', border: '#ef4444' };
        if (cm > 60) return { text: 'ปานกลาง', bg: '#ffedd5', fg: '#9a3412', border: '#f97316' };
        return { text: 'ต่ำ', bg: '#fef9c3', fg: '#854d0e', border: '#eab308' };
      };

      recentReportsEl.innerHTML = floodReports.slice(-5).reverse().map(r => {
        const v = r.water_level_m ?? r.water_level_raw_m;
        const hasVal = (v != null && isFinite(v));
        const cm = hasVal ? Math.round(v * 100) : null;
        const b = badge(cm, hasVal);

        return `
          <div class="report-item rounded-xl p-4 bg-white/70 border border-blue-100"
               style="border-left: 6px solid ${b.border}; box-shadow: 0 6px 20px rgba(59,130,246,.08);">
            <div class="flex justify-between items-start gap-3">
              <div>
                <h4 class="font-semibold text-slate-800">${r.address || `${r.lat}, ${r.lng}`}</h4>
                <p class="text-sm text-slate-600">
                  ระดับน้ำ: ${hasVal ? v.toFixed(2) : '—'} m |
                  วัตถุ: ${r.object_type || '-'} |
                  วันที่: ${thDateTime(r.date_iso)}
                </p>
                <p class="text-sm text-slate-500 mt-1">${r.description || '-'}</p>
              </div>
              <span class="text-xs px-3 py-1 rounded-full font-semibold"
                    style="background:${b.bg}; color:${b.fg}; border:1px solid rgba(0,0,0,.06);">
                ${b.text}
              </span>
            </div>
          </div>`;
      }).join('');
    }

    objectTypeInput.addEventListener('change', () => {
      if (objectTypeInput.value === 'อื่นๆ') customObjectDiv.classList.remove('hidden');
      else { customObjectDiv.classList.add('hidden'); customObjectInput.value = ''; }
    });

    document.getElementById('getLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return showAlert('ไม่รองรับการขอตำแหน่ง', 'เบราว์เซอร์ของคุณไม่รองรับการใช้งานตำแหน่ง');
      showLocationStatus('กำลังขอตำแหน่ง...', 'loading');
      getLocationBtn.disabled = true;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          locationInput.value = `${lat}, ${lng}`;
          showLocationStatus('ได้รับตำแหน่งสำเร็จ', 'success');
          getLocationBtn.disabled = false;
          map.setView([+lat, +lng], 15);
        },
        () => { showLocationStatus('ไม่สามารถขอตำแหน่งได้', 'error'); getLocationBtn.disabled = false; },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });

    let pickMap, pickMarker, pickBaseOsm, pickBaseEsri, activeBase;
    function openPickModal() {
      openModal(pickModal);
      setTimeout(() => {
        if (!pickMap) {
          pickMap = L.map('pickMap').setView(map.getCenter(), map.getZoom());
          pickBaseOsm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
          pickBaseEsri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
          activeBase = pickBaseOsm.addTo(pickMap);

          const setBase = (base) => { if (activeBase) pickMap.removeLayer(activeBase); activeBase = base.addTo(pickMap); };
          pickBaseOsmBtn.onclick = () => setBase(pickBaseOsm);
          pickBaseEsriBtn.onclick = () => setBase(pickBaseEsri);

          pickMap.on('click', (e) => {
            const { lat, lng } = e.latlng;
            if (!pickMarker) pickMarker = L.marker(e.latlng, { draggable: true }).addTo(pickMap);
            else pickMarker.setLatLng(e.latlng);
            updatePicked(lat, lng);
            pickMarker.on('dragend', () => {
              const p = pickMarker.getLatLng();
              updatePicked(p.lat, p.lng);
            });
            pickConfirm.disabled = false;
          });
        } else {
          pickMap.invalidateSize();
          pickMap.setView(map.getCenter(), map.getZoom());
        }
      }, 50);
    }
    function closePickModal() { closeModal(pickModal); }
    function updatePicked(lat, lng) { pickedLatLngEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }
    pickOnMapBtn.addEventListener('click', openPickModal);
    document.getElementById('pickCloseX').addEventListener('click', closePickModal);
    document.getElementById('pickCancel').addEventListener('click', closePickModal);
    pickModal.addEventListener('click', (e) => { if (e.target === pickModal) closePickModal(); });
    pickConfirm.addEventListener('click', () => {
      if (!pickMarker) return;
      const p = pickMarker.getLatLng();
      locationInput.value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
      closePickModal();
      showLocationStatus('เลือกพิกัดจากแผนที่เรียบร้อย', 'success');
    });

    uploadArea.addEventListener('click', () => imageInput.click());
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    imageInput.addEventListener('change', e => handleFiles(e.target.files));

    function validateFile(file) {
      if (!ALLOWED_MIME.includes(file.type)) { showAlert('ไฟล์ไม่รองรับ', `ชนิดไฟล์: ${file.type || 'unknown'} (รองรับ: JPG, PNG, WEBP)`); return false; }
      const mb = file.size / (1024 * 1024);
      if (mb > MAX_MB) { showAlert('ไฟล์มีขนาดใหญ่เกินกำหนด', `ขนาดสูงสุด ${MAX_MB} MB (ปัจจุบัน ${mb.toFixed(2)} MB)`); return false; }
      return true;
    }
    function handleFiles(files) {
      if (!files || !files.length) return;
      const ok = validateFile(files[0]);
      if (!ok) { imageInput.value = ''; fileInfo.textContent = ''; return; }
      uploadArea.innerHTML = `
        <p class="text-lg text-green-700 mb-1 font-semibold">เลือกไฟล์เรียบร้อย</p>
        <p class="text-sm text-slate-700 font-medium">${files[0].name} (${(files[0].size / 1024 / 1024).toFixed(2)} MB)</p>`;
    }

    function parseLatLng(text) {
      if (!text) return null;
      const p = text.split(',').map(s => s.trim());
      if (p.length !== 2) return null;
      const lat = Number(p[0]), lng = Number(p[1]);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      return { lat, lng };
    }
    function downloadBlob(content, filename, mime) {
      const blob = new Blob([content], { type: mime || 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    function toCsv(rows, headers) {
      const esc = (v) => { const s = (v == null) ? '' : String(v); return /[,"\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s; };
      const head = headers.map(esc).join(',');
      const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
      return head + '\n' + body;
    }

    submitBtn.addEventListener('click', async () => {
      const loc = parseLatLng(locationInput.value.trim());
      const objectType = objectTypeInput.value;
      const finalObject = objectType === 'อื่นๆ' ? (customObjectInput.value.trim()) : objectType;
      const description = (descriptionInput.value || '').trim();
      const address = (addressInput.value || locationInput.value).trim();

      if (!imageInput.files?.length) return showAlert('กรุณาเลือกไฟล์', 'โปรดเลือกภาพอย่างน้อยหนึ่งไฟล์');
      if (!validateFile(imageInput.files[0])) return;
      if (!loc) return showAlert('พิกัดไม่ถูกต้อง', 'กรุณากรอกตำแหน่งเป็น "lat, lng" เช่น 18.7883, 98.9853');
      if (!finalObject) return showAlert('กรุณาระบุวัตถุ', 'โปรดเลือกหรือกรอกวัตถุที่ถ่าย');

      const nowIso = new Date().toISOString();

      const fd = new FormData();
      fd.append('image', imageInput.files[0]);
      fd.append('lat', String(loc.lat));
      fd.append('lng', String(loc.lng));
      fd.append('date_iso', nowIso);
      fd.append('object_type', finalObject);
      fd.append('description', description);
      fd.append('address', address);

      submitBtn.disabled = true;
      const prevText = submitBtn.textContent;
      submitBtn.textContent = 'กำลังบันทึก...';

      try {
        const url = `${API_BASE}/api/report?skip_infer=${SKIP_INFER}`;
        const res = await fetch(url, { method: 'POST', body: fd, mode: 'cors' });
        const raw = await res.text();
        let data; try { data = raw ? JSON.parse(raw) : null; } catch (e) { throw new Error(`การตอบกลับไม่ใช่ JSON (HTTP ${res.status}). ข้อมูล: ${raw.slice(0, 300)}`); }
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} — ${data?.message || raw.slice(0, 300)}`);
        if (!data?.ok) throw new Error(`API error: ${data?.message || 'ok=false'}`);

        floodReports.push(data);
        addReportToMap(data);
        map.setView([data.lat, data.lng], 16);

        updateStats();
        renderReports();

        imageInput.value = '';
        uploadArea.innerHTML = `
          <svg class="w-20 h-20 mx-auto mb-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
          </svg>
          <p class="text-lg text-blue-700 mb-2 font-medium">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
          <p class="text-sm text-slate-600 font-medium">รองรับไฟล์ JPG, PNG, WEBP (ขนาดไม่เกิน 10MB)</p>
        `;

        showAlert('บันทึกสำเร็จ', 'ข้อมูลของคุณได้รับการบันทึกเรียบร้อยแล้ว');
      } catch (err) {
        showAlert('บันทึกไม่สำเร็จ', String(err.message || err));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = prevText;
      }
    });

    (async function initReports() {
      try {
        const res = await fetch(`${API_BASE}/api/reports?limit=200`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data?.ok && Array.isArray(data.items)) {
          floodReports = data.items;
          floodReports.forEach(addReportToMap);
          fitMapToMarkers();
          updateStats();
          renderReports();
        }
      } catch (err) { showAlert('ไม่สามารถโหลดข้อมูลเริ่มต้น', String(err.message || err)); }
    })();

    function computeIdwGrid(points, cellKm = 0.25) {
      if (!points || !points.length) return null;
      const feats = points.map(p => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [p.lng, p.lat] },
        properties: { value: p.water_level_m * 100 }
      }));
      const fc = { type: 'FeatureCollection', features: feats };
      return turf.interpolate(fc, cellKm, { gridType: 'square', property: 'value', units: 'kilometers' });
    }
    function normalizeBoundary(gj) {
      if (!gj) return null;
      if (gj.type === 'Feature' && (gj.geometry?.type === 'Polygon' || gj.geometry?.type === 'MultiPolygon')) return gj;
      const feats = (gj.type === 'FeatureCollection') ? gj.features : [gj];
      const polys = feats.map(f => (f.type === 'Feature' ? f.geometry : f))
        .filter(g => g && (g.type === 'Polygon' || g.type === 'MultiPolygon'))
        .map(g => turf.feature(g));
      if (!polys.length) return null;
      let merged = polys[0];
      for (let i = 1; i < polys.length; i++) { try { merged = turf.union(merged, polys[i]); } catch { } }
      return merged || polys[0];
    }
    function clipGridToBoundary(grid, boundary) {
      if (!grid || !boundary) return grid;
      const out = { type: 'FeatureCollection', features: [] };
      for (const cell of grid.features) {
        try {
          const inter = turf.intersect(cell, boundary);
          if (inter) {
            inter.properties = inter.properties || {};
            inter.properties.value = cell.properties?.value ?? null;
            out.features.push(inter);
          }
        } catch (_) { }
      }
      return out;
    }
    function renderIdw(grid) {
      if (idwLayer) { map.removeLayer(idwLayer); idwLayer = null; }
      lastIdwGeoJson = null;
      if (!grid) { showAlert('ไม่สามารถคำนวณ Interpolation', 'ยังไม่มีจุดเพียงพอสำหรับคำนวณ'); return; }
      let clipped = boundaryGeoJson ? clipGridToBoundary(grid, boundaryGeoJson) : grid;
      if (!clipped.features?.length) clipped = grid;
      lastIdwGeoJson = clipped;
      idwLayer = L.geoJSON(clipped, {
        pane: 'idwPane',
        style: f => ({ color: colorByCm(f.properties.value), fillColor: colorByCm(f.properties.value), fillOpacity: 0.35, weight: 0 })
      }).addTo(map);
    }
    document.getElementById('toggleIdw').addEventListener('click', () => {
      if (!idwLayer && (!floodReports || floodReports.length === 0)) {
        showAlert('ยังไม่มีข้อมูลจุด', 'เพิ่มอย่างน้อย 1 จุดก่อนจะแสดง Interpolation');
        return;
      }
      if (idwLayer) { map.removeLayer(idwLayer); idwLayer = null; lastIdwGeoJson = null; return; }
      const pts = floodReports
        .map(r => r.water_level_m ?? r.water_level_raw_m)
        .map((v, i) => ({ v, i }))
        .filter(o => o.v != null && isFinite(o.v))
        .map(o => ({ lat: floodReports[o.i].lat, lng: floodReports[o.i].lng, water_level_m: o.v }));
      const grid = computeIdwGrid(pts, 0.25);
      renderIdw(grid);
    });

    exportCsvBtn.addEventListener('click', () => {
      if (!floodReports.length) return showAlert('ไม่พบข้อมูล', 'ยังไม่มีข้อมูลรายงานสำหรับดาวน์โหลด');

      const enriched = floodReports.map(r => ({
        ...r,
        created_at_th: r.date_iso
          ? new Date(r.date_iso).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', hour12: false })
          : ''
      }));

      const headers = ['lat', 'lng', 'date_iso', 'created_at_th', 'object_type', 'description', 'address', 'photo_url', 'water_level_m'];
      const csv = toCsv(enriched, headers);
      downloadBlob(csv, `flood_reports_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`, 'text/csv;charset=utf-8');
    });

    exportIdwBtn.addEventListener('click', () => {
      if (!lastIdwGeoJson) {
        const pts = floodReports
          .map(r => r.water_level_m ?? r.water_level_raw_m)
          .map((v, i) => ({ v, i }))
          .filter(o => o.v != null && isFinite(o.v))
          .map(o => ({ lat: floodReports[o.i].lat, lng: floodReports[o.i].lng, water_level_m: o.v }));
        const grid = computeIdwGrid(pts, 0.25);
        if (!grid) return showAlert('ไม่สามารถดาวน์โหลด', 'ยังไม่มีข้อมูลเพียงพอสำหรับคำนวณ Interpolation');
        lastIdwGeoJson = boundaryGeoJson ? clipGridToBoundary(grid, boundaryGeoJson) : grid;
        if (!lastIdwGeoJson.features?.length) lastIdwGeoJson = grid;
      }
      downloadBlob(JSON.stringify(lastIdwGeoJson), `flood_interpolation_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.geojson`, 'application/geo+json;charset=utf-8');
    });

    function addBoundary(rawGj) {
      if (boundaryLayer) { map.removeLayer(boundaryLayer); boundaryLayer = null; }
      const normalized = normalizeBoundary(rawGj);
      if (!normalized) { showAlert('ขอบเขตไม่ถูกต้อง', 'ไฟล์ GeoJSON ต้องเป็น Polygon/MultiPolygon'); return; }
      boundaryGeoJson = normalized;
      boundaryLayer = L.geoJSON(boundaryGeoJson, {
        pane: 'boundaryPane',
        interactive: false,
        style: { color: '#2563eb', weight: 2, fillOpacity: 0.05 }
      }).addTo(map);
      overlays['ขอบเขตเทศบาล'] = boundaryLayer;
      document.querySelectorAll('.leaflet-control-layers').forEach(el => el.remove());
      L.control.layers(baseLayers, overlays, { position: 'topright', collapsed: false }).addTo(map);
      try { map.fitBounds(boundaryLayer.getBounds(), { padding: [20, 20] }); } catch { }
    }
    (async function tryLoadDefaultBoundary() {
      try {
        const res = await fetch(DEFAULT_BOUNDARY_URL, { cache: 'no-store' });
        if (res.ok) { const gj = await res.json(); addBoundary(gj); }
      } catch { }
    })();
  </script>
</body>

</html>